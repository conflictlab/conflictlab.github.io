name: Sync Forecast CSVs

permissions:
  contents: write

on:
  push:
    branches: [ main ]
    paths:
      - 'scripts/**'
      - 'content/forecasts/**'
      - 'content/priogrid_cellshp/**'
      - 'package.json'
      - 'app/forecasts-grid/**'
      - 'components/PrioGridMap.tsx'
      - '.github/workflows/sync-forecasts.yml'
  schedule:
    - cron: '0 3 1 * *' # 03:00 UTC on the 1st of every month
  workflow_dispatch: {}

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Sync forecasts from GitHub CSVs
        run: |
          npm run csv:sync:github -- \
            --repo ThomasSchinca/Pace-map-risk \
            --dir Historical_Predictions \
            --branch main \
            --latestOnly \
            --saveCsv
      - name: Build PRIO-GRID centroids from shapefile
        run: npm run grid:centroids
      - name: Build PRIO-GRID GeoJSON from live CSV
        run: npm run grid:build

      - name: Build monthly point JSONs
        run: node scripts/geojson-to-month-points.js

      - name: Download scenarios pickle from GitHub
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SCE_REPO: ${{ vars.SCE_REPO || 'ThomasSchinca/Pace-map-risk' }}
          SCE_PATH: ${{ vars.SCE_PATH || 'sce_dictionary.pkl' }}
          SCE_BRANCH: ${{ vars.SCE_BRANCH || 'main' }}
        run: |
          mkdir -p tmp
          curl -sSL \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "Accept: application/vnd.github.v3.raw" \
            "https://api.github.com/repos/${SCE_REPO}/contents/${SCE_PATH}?ref=${SCE_BRANCH}" \
            -o tmp/sce_dictionary.pkl || true
          if [ ! -s tmp/sce_dictionary.pkl ]; then echo "No scenarios pickle downloaded (optional)"; fi

      - name: Setup Python for scenarios conversion
        if: ${{ hashFiles('tmp/sce_dictionary.pkl') != '' }}
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Convert scenarios pickle to JSON (pandas 1.5)
        if: ${{ hashFiles('tmp/sce_dictionary.pkl') != '' }}
        run: |
          python -m pip install --quiet numpy==1.24.4 pandas==1.5.3
          python - <<'PY'
          import pickle, json, numpy as np, pandas as pd, sys, os
          from pathlib import Path
          p=Path('tmp/sce_dictionary.pkl')
          if not p.exists():
              print('No pickle present; skipping.')
              sys.exit(0)
          with p.open('rb') as f:
              obj = pickle.load(f)
          def to_basic(x):
              if isinstance(x, np.ndarray): return x.tolist()
              if isinstance(x, (pd.Series, pd.Index)): return x.tolist()
              if isinstance(x, pd.DataFrame): return x.to_dict(orient='list')
              if isinstance(x, dict): return {str(k): to_basic(v) for k,v in x.items()}
              if isinstance(x, (list, tuple)): return [to_basic(v) for v in x]
              return x
          san = to_basic(obj)
          os.makedirs('public/data', exist_ok=True)
          with open('public/data/scenarios.json','w') as out:
              json.dump(san, out)
          n = len(san) if isinstance(san, dict) else 'unknown'
          print('Converted scenarios to public/data/scenarios.json; entries:', n)
          # Print a quick summary to logs
          if isinstance(san, dict):
              keys = list(san.keys())[:10]
              print('Sample keys:', keys)
          PY

      - name: Commit changes (if any)
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git add content/forecasts public/data/csv public/data/grid public/data/scenarios.json || true
          git diff --cached --quiet || git commit -m "chore: sync forecasts + grid assets (centroids, geojson, monthly points)"
          git push
